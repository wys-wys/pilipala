name: Pilipala Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "可选：手动触发时填写 tag（例如 v1.2.3）。不填只产物不发 Release"
        required: false
        type: string
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  FLUTTER_VERSION: "3.19.6"

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Decode jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/vvex.jks

      - name: Build APK
        run: |
          flutter build apk --release --split-per-abi
          flutter build apk --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Get version
        id: ver
        env:
          INPUT_TAG: ${{ inputs.release_tag }}
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ -n "$INPUT_TAG" ]]; then
            TAG="$INPUT_TAG"
          else
            TAG="manual-${GITHUB_SHA::7}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename APKs
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          OUT="build/app/outputs/flutter-apk"
          for f in "$OUT"/*.apk; do
            [ -e "$f" ] || continue
            b="$(basename "$f")"
            mv "$f" "$OUT/Pili-${b%.apk}-$VERSION.apk"
          done

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/Pili-*.apk
          if-no-files-found: error

  ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Build IPA (no codesign)
        run: |
          flutter build ios --release --no-codesign
          rm -rf Payload app.ipa
          mkdir -p Payload
          cp -R build/ios/iphoneos/Runner.app Payload/Runner.app
          (cd Payload && zip -r ../app.ipa Runner.app)

      - name: Get version
        id: ver
        env:
          INPUT_TAG: ${{ inputs.release_tag }}
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ -n "$INPUT_TAG" ]]; then
            TAG="$INPUT_TAG"
          else
            TAG="manual-${GITHUB_SHA::7}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename IPA
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          mkdir -p build
          mv app.ipa "build/Pili-$VERSION.ipa"

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/Pili-*.ipa
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: [android, ios]
    if: ${{ startsWith(github.ref, 'refs/tags/') || inputs.release_tag != '' }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-apk|*-ipa"
          path: artifacts
          merge-multiple: true

      - name: Get tag
        id: tag
        env:
          INPUT_TAG: ${{ inputs.release_tag }}
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="$INPUT_TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          artifacts: artifacts/**/*
          allowUpdates: true
          token: ${{ secrets.GIT_TOKEN }}
