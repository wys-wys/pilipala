name: Pilipala Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "手动触发时填写 Tag（例如 v1.2.3）"
        required: true
        default: "v0.0.0"
  push:
    tags:
      - "v*.*.*"

env:
  FLUTTER_VERSION: "3.19.6"

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: 代码迁出
        uses: actions/checkout@v4

      - name: 构建Java环境
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: gradle

      - name: 安装Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 下载项目依赖
        run: flutter pub get

      - name: 解码生成 jks
        run: echo "$KEYSTORE_BASE64" | base64 --decode > android/app/vvex.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: flutter build apk (split per abi)
        run: flutter build apk --release --split-per-abi
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: flutter build apk (universal)
        run: flutter build apk --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: 获取版本号
        id: version
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${INPUT_TAG}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: 重命名 APK
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          OUTDIR="build/app/outputs/flutter-apk"
          for file in "$OUTDIR"/app-*-release.apk "$OUTDIR"/app-release.apk; do
            [ -e "$file" ] || continue
            base=$(basename "$file")
            if [[ "$base" == "app-release.apk" ]]; then
              prefix=""
            else
              abi="${base#app-}"
              abi="${abi%-release.apk}"
              prefix="${abi}-"
            fi
            mv "$file" "$OUTDIR/Pili-${prefix}${VERSION}.apk"
          done

      - name: 上传 Android 产物
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/Pili-*.apk
          if-no-files-found: error

  ios:
    runs-on: macos-latest
    steps:
      - name: 代码迁出
        uses: actions/checkout@v4

      - name: 安装Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 下载项目依赖
        run: flutter pub get

      - name: flutter build ipa（no codesign）
        run: |
          flutter build ios --release --no-codesign
          rm -rf Payload
          mkdir -p Payload
          cp -R build/ios/iphoneos/Runner.app Payload/
          (cd Payload && zip -r ../app.ipa Runner.app)

      - name: 获取版本号
        id: version
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${INPUT_TAG}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: 重命名 IPA
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p build
          mv app.ipa "build/Pili-${VERSION}.ipa"

      - name: 上传 iOS 产物
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/Pili-*.ipa
          if-no-files-found: error

  upload:
    runs-on: ubuntu-latest
    needs: [android, ios]
    steps:
      - name: 下载 Android 产物
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: release

      - name: 下载 iOS 产物
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: release

      - name: 查看产物
        run: |
          ls -lah release
          find release -maxdepth 2 -type f -print

      - name: 获取版本号
        id: version
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${INPUT_TAG}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Upload Release
        uses: ncipollo/release-action@v1
        with:
          name: v${{ steps.version.outputs.version }}
          tag: v${{ steps.version.outputs.version }}
          token: ${{ secrets.GIT_TOKEN }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          omitPrereleaseDuringUpdate: true
          artifacts: release/*
